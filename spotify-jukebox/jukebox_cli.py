# #==================================================================================================================# #
# #==================================================================================================================# #
# #==================================================== IMPORTS =====================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #

import jukebox_backend as jb
import spotify_interface as sp

from requests import get, post, put, delete
from datetime import datetime, timedelta

# #==================================================================================================================# #
# #==================================================================================================================# #
# #=================================================== CONSTANTS ====================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #

# #==================================================================================================================# #
# #==================================================================================================================# #
# #================================================ GLOBAL VARIABLES ================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #

# #==================================================================================================================# #
# #==================================================================================================================# #
# #=================================================== FUNCTIONS ====================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #



jukebox_api_endpoint = "127.0.0.1:5000"

def query_tracks():
    pass

def select_track_from_query():
    new_query = False
    while True:
        query_str = ""
        while len(query_str) == 0:
            query_str = input("Enter search query for your desired song:\n").strip()
        tracks : list[sp.Track] = sp.search(query=query_str, sp_user_id="0", types=["track"], num_each_items=9)["tracks"]
        print(display_options([f"{t.name} - {t.artists[0].name}" for t in tracks]))
        while True:
            ui = input("\nSelect the song you want from above [1-9]\nOR press return/enter to start a new search query:\n").strip().lower()
            if ui.split()[0].isnumeric() and (n:=int(ui.split()[0])) <= 9 and n > 0:
                break
            if ui == "":
                break
        # if query has been completed and song has been selected
        if not ui == "":
            sel_track = tracks[n-1]
            jb.add_track(sel_track)
            display_jukebox()
            break


def display_jukebox() -> str:
    result =""
    i = 0
    for track in jb.JUKEBOX:
        result += " > " if i == jb.JUKEBOX_POS else "   "
        result += f"{i+1}. {track.name} - {' '.join([a.name for a in track.artists])}"
        i += 1
    print(result)
    return result

menu = {
    "jukebox": [
        "Request Song", 
        "Skip to Next", 
        "Skip to Previous",
        "Stop Playback", 
        "Resume Playback", 
        "View Jukebox"
    ]


}

def display_options(options : list[str]):
    return "\n"+"\n".join([f"{options.index(o)+1}. {o}" for o in options])

def do_menu_options(node):
    print(display_options(node))
    ui = None
    while True:
        ui = input().strip().lower()
        if ui.split()[0].isnumeric() and (n:=int(ui.split()[0])) <= len(node) and n > 0:
            break
        if ui in ("exit", "quit", "q"):
            print("Goodbye!")
            exit()
    
    
    print(f"selected: {(sel:=menu['jukebox'][n-1])}")

    if sel == "Request Song":
        select_track_from_query()
        


while True:
    do_menu_options(menu["jukebox"])
    

# #==================================================================================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #
# #============================================= Code Written by a-dubs =============================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #
# #==================================================================================================================# #

